<?xml version="1.0" encoding="UTF-8"?>
<definitions id="definitions" 
  xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:activiti="http://activiti.org/bpmn"
  targetNamespace="http://activiti.org/bpmn20">
  
  <process id="rechargeProcess" name="汇款充值操作流程">
  	 <startEvent id="theStart" />
     <sequenceFlow id="flow1" sourceRef="theStart" targetRef="createRechargeTask" />
    
     <serviceTask id="createRechargeTask" name="创建汇款充值工单" 
       activiti:delegateExpression="${createRechargeTaskDelegate}" />    
     <sequenceFlow id="flow2" sourceRef="createRechargeTask" targetRef="notifyFinancialUser" />
     
     <serviceTask id="notifyFinancialUser" name="通知财务人员" 
       activiti:delegateExpression="${notifyFinancialUserDelegate}" />    
     <sequenceFlow id="flow3" sourceRef="notifyFinancialUser" targetRef="claimRechargeTask" />
     
     <userTask id="claimRechargeTask" name="认领汇款充值工单">
     	<documentation>
     		财务人员领取(claim)工单
     	</documentation>
    	<extensionElements>
		    <activiti:taskListener delegateExpression="${processTaskListener}" event="create"/>
		</extensionElements>
     </userTask>
     <sequenceFlow id="flow4" sourceRef="claimRechargeTask" targetRef="financialUserAmountGw" />
     
     <!-- <userTask id="handleRechargeTask" name="开始处理汇款充值工单">
     	<documentation>
     		财务人员开始处理汇款充值工单
     	</documentation>
     </userTask>
     <sequenceFlow id="flow5" sourceRef="handleRechargeTask" targetRef="financialUserAmountGw" /> -->
     
     <!-- start 额度判断 -->
     <exclusiveGateway id="financialUserAmountGw" name="操作人员额度判断" /> 
     <sequenceFlow id="endFlow6" sourceRef="financialUserAmountGw" targetRef="returnRechargeTask">
	     <documentation>
	     	额度不足，退回已领取汇款充值任务
	     </documentation>
     	<conditionExpression xsi:type="tFormalExpression">${!enough}</conditionExpression>
     </sequenceFlow>
     <sequenceFlow id="endFlow7" sourceRef="financialUserAmountGw" targetRef="queryFinancialAccount">
     	 <documentation>
	     	额度充足，继续执行
	     </documentation>
     	<conditionExpression xsi:type="tFormalExpression">${enough}</conditionExpression>
     </sequenceFlow>
     <!-- end 额度判断 -->
     
     <!-- start 额度不足情况 -->
     <userTask id="returnRechargeTask" name="退回已领取汇款充值任务">
     </userTask>
     <sequenceFlow id="flow8" sourceRef="returnRechargeTask" targetRef="notifyHigherFinancialUser" />
     
     <serviceTask id="notifyHigherFinancialUser" name="通知上级财务人员" 
       activiti:delegateExpression="${notifyHigherFinancialUserDelegate}" />    
     <sequenceFlow id="flow9" sourceRef="notifyHigherFinancialUser" targetRef="claimRechargeTask" />
     <!-- end 额度不足情况 -->
     
     <!-- start 额度充足情况 -->
     <userTask id="queryFinancialAccount" name="查询汇款是否到帐"></userTask>
     <sequenceFlow id="flow10" sourceRef="queryFinancialAccount" targetRef="receiveMoneyGw" />
     <!-- start 是否到帐 -->
     <exclusiveGateway id="receiveMoneyGw" name="是否到帐判断" /> 
     <sequenceFlow id="endFlow11" sourceRef="receiveMoneyGw" targetRef="rejectRechargeTask">
	     <documentation>
	     	未到帐
	     </documentation>
     	<conditionExpression xsi:type="tFormalExpression">${!received}</conditionExpression>
     </sequenceFlow>
     <sequenceFlow id="endFlow12" sourceRef="receiveMoneyGw" targetRef="approveRechargeTask">
     	 <documentation>
	     	已到帐
	     </documentation>
     	<conditionExpression xsi:type="tFormalExpression">${received}</conditionExpression>
     </sequenceFlow>
     <!-- end 是否到帐 -->
     
     <!-- start 未到帐情况 -->
     <userTask id="rejectRechargeTask" name="汇款充值失败">
     </userTask>
     <sequenceFlow id="flow13" sourceRef="rejectRechargeTask" targetRef="notifyInitiator" />
     <!-- end 未到帐情况 -->
     
     <!-- start 已到帐情况 -->
     <userTask id="approveRechargeTask" name="填写手续费，批准">
     </userTask>
     <sequenceFlow id="flow14" sourceRef="approveRechargeTask" targetRef="notifyInitiator" />
     <!-- end 已到帐情况 -->
     <!-- end 额度充足情况 -->
     <serviceTask id="notifyInitiator" name="短信通知工单发起人" activiti:delegateExpression="${notifyInitiatorDelegate}" />
     <sequenceFlow id="flow15" sourceRef="notifyInitiator" targetRef="theEnd" /> 
     <endEvent id="theEnd" />
  </process>
  
</definitions>